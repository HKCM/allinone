

### 概述

Amazon Simple Storage Service (Amazon S3) 是一项面向 Internet 的对象存储服务。您可以通过 Amazon S3 随时在 Web 上的任何位置存储和检索的任意大小的数据。Amazon S3 仅按照实际使用容量收费,没有任何隐性收费和超容量收费。这为开发人员提供了一种可变成本服务,这种服务可以伴随业务共同发展,同时还可以享受 AWS 的基础设施成本优势。

我们使用一个东西我们会问,它能用来干什么:
1. 备份和存储 - 为其他应用程序提供数据备份和存储服务。
2. 应用程序托管 - 提供部署、安装和管理 Web 应用程序的服务。
3. 媒体托管 - 构建托管视频、照片或音乐上传和下载的高可用性、冗余式、可扩展基础设施。
4. 软件传输 - 托管可供客户下载的软件应用程序。

下一个问题,对象存储服务很多公司都有,为什么选择S3:
1. 无限容量 - 单个bucket没有容量限制,可以无限存储,但是单个对象最大为5T
2. 对象版本控制 - 版本控制无需解释吧
3. 对象生命周期控制 - 例如对象只存储7天,自动删除
4. 智能分层 - 短时间频繁访问的数据,一周后不一定还有人访问,可以将不频繁访问的数据自动归档节约成本
4. 可以托管静态网站 - 例如放入html可以当个网站来用
5. 精细的权限控制
6. 可以使用 BitTorrent 协议
7. 使用基于标准的 REST 接口
8. 在指定年度内为对象提供 99.999999999% 的持久性和 99.99% 的可用性
9. 落盘加密,Amazon S3 在将对象保存到其磁盘上之前对其进行加密,并在下载对象时对其进行解密。

#### 基本概念
* 存储桶 - bucket 存储对象的容器
* 对象 - object 要存储的对象(文件,音频,视频等)
* 键 - key 对象存入存储桶后唯一的标识符
* 区域 - 你选择的AWS S3服务的所在位置

### 对象

Amazon S3 存储桶和对象没有层次结构。但是,通过在对象键名中使用前缀和分隔符,Amazon S3 控制台和 AWS 开发工具包可以推断层次结构并引入文件夹的概念。

#### 对象命名要注意的问题

1. 可能需要特殊处理的字符

键名中的以下字符可能需要另外进行代码处理,并且可能需要以十六进制形式在 URL 中编码或引用。其中部分字符是不可打印的字符,浏览器可能无法处理它们,这也需要特殊处理:

* 表示和的符号 (“&”)
* 美元 (“$”)
* ASCII 字符范围 00-1F 十六进制(0-31 十进制)和 7F(127 十进制)
* “At”符号 (“@”)
* 等于 (“=”)
* 分号 (“;”)
* 冒号 (“:”)
* 加号 (“+”)
* 空格 - 大量连续空格可能会在某些使用情形中丢失(特别是多个空格)
* 逗号 (“,”)
* 问号 (“?”)

2. 要避免的字符

避免在键名中使用以下字符,因为这些字符需要进行大量的特殊处理,才能在所有应用程序间保持一致性。

* 反斜杠 ("\")
* 左大括号 (“{”)
* 不可打印的 ASCII 字符(128-255 十进制字符)
* 插入符号 (“^”)
* 右大括号 (“}”)
* 百分比字符 (“%”)
* 重音符/反勾号 (“`”)
* 右方括号 (“]”)
* 引号
* “大于”符号 (“>”)
* 左方括号 (“[”)
* 波浪字符 (“~”)
* “小于”符号(“<”)
* “井号”字符 (“#”)
* 竖线 (“|”)

#### [对象元数据](https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/UsingMetadata.html#object-metadata)


### 存储类别和定价

#### S3 存储分类
存储大致分为4类,每种的适用性不同,
1. 经常访问对象的存储类 

S3标准,频繁访问层,适用于经常访问的数据,标准费用

2. 不经常访问对象的存储类

S3标准-IA(Infrequent Access),不频繁访问层,不经常访问对象的存储类称为IA,费用比标准费用低一些。又分为两类,S3 标准-IA(也就是多可用区)和S3 单区-IA

类别|价格|可用性
-|-|-
S3 标准-IA|高|高
S3 单区-IA|低|低

3. S3智能分层

结合了`1`和`2`,当数据30天内没有访问就自动将对象从`S3标准`转变为`S3标准IA`,如果不频繁访问层中的对象被访问,则对象将自动移回频繁访问层。但是智能分层要收取一个0.0025 USD/1000 个对象的管理费. 在 S3 智能分层存储类中的访问层之间移动对象时,不会产生额外的分层费用。

4. 存档对象的存储类

`S3 Glacier` 和 `S3 Glacier Deep Archive` 存储类别是专门为低成本的数据存档而设计的。费用很低,只有标准存储的5分之一,适合在政策层面上要求长时间存储的数据,对象不可用于实时访问。而上述`1`,`2`,`3`都可以实时访问。

例如,证券公司或者财务公司要求对客户资料必须存储2年以上,但其实存储之后并不会频繁访问而仅是用于备份。如果需要访问存档对象的话,需要提前`解冻`时间在几分钟到2天不等。

简单理解就是存档对象进行了加压,读取时需要解压所以需要时间


存储类别   |设计专门针对                              |持久性(设计目标)|可用性|可用区|最小存储持续时间|最小可计费对象|其他考虑因素
|-|-|-|-|-|-|-|-|
S3 标准    |经常访问的数据                            |99.999999999%   |99.99%|>=3   |无              |无            |无
S3 标准-IA |长时间存在的、不经常访问的数据            |99.999999999%   |99.9% |>=3   |30 天           |128 KB        |按每GB收取检索费用。
S3 智能分层|访问模式发生变化或未知的长时间存在的数据  |99.999999999%   |99.9% |>=3   |30 天           |无            |按对象收取监控和自动化费用。无检索费用。
S3 单区-IA |长时间存在的、不经常访问的、非关键数据    |99.999999999%   |99.5% |1     |30 天           |128 KB        |按每GB收取检索费用。无法灵活地应对可用区丢失的情况。
S3 Glacier |检索时间从数分钟到数小时不等的长期数据存档|99.999999999%	 |99.99%|>=3   |90 天           |40 KB         |按每GB收取检索费用。必须先还原存档对象,然后才可以访问它
S3 Glacier Deep Archive|存档很少访问的数据,默认检索时间为 12 小时	|99.999999999%	|99.99% (在您还原对象之后)|>=3|180 天|40 KB|按每GB收取检索费用。必须先还原存档对象,然后才可以访问它们

#### [对象存储类别](https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/storage-class-intro.html)


#### S3 价格

S3价格由4各方面组成
1. 存储费用
2. 请求和检索费用 - 可以理解为API的调用费用,PUT,LIST
3. 数据传输费用 - 带宽也是要钱的
4. 管理和复制费用 - 这个可以理解为S3 bucket的功能费用,使用了相关功能就需要付费,例如跨区复制功能和对象标记功能

我主要讲讲存储和数据传输费用,因为请求和检索费用以及管理和复制费用取决于个人的使用情况不太好分析。

##### 存储费用
这个价格基于`us-east-1`区域
存储类别|价格
-|-
S3标准|每 GB 0.023 USD
S3标准-IA|每 GB 0.0125 USD
S3单区-IA|每 GB 0.01 USD
S3 Glacier|每 GB 0.004 USD
S3 Glacier Deep Archive|每 GB 0.00099 USD

智能分层还要收取一个0.0025 USD/1000 个对象的管理费.

##### 数据传输费用

1. 所有传入不收费
2. 传出到同一区域的EC2(不论是不是你的)不收费
3. 传出到CloudFront不收费,因为CloudFront要收费,CloudFront是AWS的CDN服务,以后单讲

所以传出费用大概是每 GB 0.09 USD,这是传出的最高值,具体规则参考官方文档。

所以举例说明,假如你只存了1G数据在S3上并公开,但是有人疯狂下载,S3费用可能也会很高。

费用详情请参考官方文档:https://amazonaws-china.com/cn/s3/pricing/


### Amazon S3 数据一致性模型
Amazon S3 在所有区域为 S3 存储桶中的**新对象的 PUTS 提供写后读一致性**,不过有一条警告。需要注意的是,如果在创建对象之前向键名称发出 HEAD 或 GET 请求,然后在此之后不久创建对象,则由于最终一致性,后续 GET 可能不会返回该对象。

Amazon S3 在所有区域提供最终一致性用于覆盖 PUTS 和 DELETES。

单个键的更新是原子更新。例如,如果您对一个现有键执行 PUT 操作,则后续读取可能会返回旧数据或已更新的数据,但它永远不会返回损坏的数据或部分数据。

Amazon S3 通过在 AWS 数据中心内的多个服务器之间复制数据,从而实现高可用性。如果 PUT 请求成功,则数据已安全存储。但是,有关更改的信息必须在 Amazon S3 间进行复制,这可能需要一些时间,因此您可能会观察到以下行为:

* 这是一个过程,会将一个新对象写入 Amazon S3,并立即列出其存储桶内的密钥。在充分传播此更改前,此对象可能不会显示在列表中。
* 这是一个过程,会替换一个现有的对象,并立即尝试读取此对象。在充分传播此更改前,Amazon S3 可能会返回先前的数据。
* 这是一个过程,会删除一个现有的对象,并立即尝试读取此对象。在充分传播此删除前,Amazon S3 可能会返回删除的数据。
* 这是一个过程,会删除一个现有的对象,并立即列出其存储桶内的键。在充分传播此删除前,Amazon S3 可能会列出删除的对象。

### 限制

1. 分区中bucket名字必须唯一,只能由小写字母、数字、句点 (.) 和连字符 (-) 组成。
    分区唯一 ,分区是一组区域。AWS 目前有三个分区:aws(标准区域)、aws-cn(中国区域)和 aws-us-gov(AWS GovCloud [美国] 区域)
2. 单个文件5T大小限制
3. 每个 AWS 账户中创建多达 100 个存储桶,通过提交服务限制提高请求将账户的存储桶限制提高至最多 1,000 个存储桶
4. 存储桶归创建它的 AWS 账户所有。存储桶所有权不可转让

### 注意事项

1. 使用S3最重要就是注意S3的权限,千万不能把机密的bucket公开可访问。创建bucket时默认是不公开的。
2. 因为bucket名字是唯一的,可能某些原因你删除了bucket,再想创建时可能就被其他人提前创建,而导致你无法创建。跟进一步的问题可能是,程序代码中有写到向这个S3发送东西,会造成意想不到的事。尤其是bucket的访问日志存储桶。所以如果bucket后续还要使用,请不要删除。
3. S3存储是最终一致性的,存储了一个对象,马上去访问不一定能拿到你要的结果,但最终会是你要的结果。A和B同时存储一个对象
4. 所有未经身份验证的请求均由匿名用户发起。此用户在访问控制列表 (ACL) 中由特定的规范用户 ID 65a011a29cdf8ec533ec3d1ccaae921c 表示。

### AWS 集成
可以单独使用 Amazon S3,也可以将其与一个或多个 Amazon 产品配合使用。以下是最常用于 Amazon S3 的产品:

* Amazon EC2
* Amazon EMR
* Amazon SQS
* Amazon CloudFront

### 结语

以上完全基于[AWS官方文档](https://docs.aws.amazon.com/),并结合自身理解创作

