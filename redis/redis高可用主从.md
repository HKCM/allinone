# 主从模式

## 作用

主从复制的作用主要包括：
- 数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。
- 故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。
- 负载均衡：在主从复制的基础上，配合读写分离，由主节点提供写服务，从节点提供读服务，分担服务器负载；大大提高Redis服务器的并发量。
- 高可用基石：除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础。

建立主从连接
```bash
# 在从节点执行
# 172.16.19.3 是主节点的IP
replicaof 172.16.19.3 6379
```

## 同步过程

### 主从全量同步原理

情况出现在从节点第一次连接主节点

1. 从节点请求数据同步，声明自己的`replication id`和`offset`
2. 主节点检查`replication id`是否第一次同步，如果是第一次，则返回版本信息，从节点保存信息
3. 主节点执行`bgsave`生成RDB文件并发送给从节点
4. 从节点清空本地数据，并加载主节点的RDB文件
5. 于此同时主节点将新的数据的命令记录到`repl_backlog`内存缓冲区中
6. 将`repl_backlog`发送到从节点，完成全量数据同步

### 主从增量同步原理

情况出现在从节点宕机之后，重新连接主节点

`repl_backlog`是一个环，从节点一直在追主节点，如果从节点落后一圈那么增量同步会失败，就需要做全量同步

1. 从节点请求数据同步，声明自己的`replication id`和`offset`
2. 主节点检查`replication id`是否第一次同步，因为`replication id`相同说明不是第一次连接
3. 主节点通过从节点的`offset`定位日志偏移量，只发送`repl_backlog`在`offset`之后的数据

### 优化同步效率

1. 在master中配置`repl-diskless-sync yes`启用无磁盘复制,避免全量同步时的磁盘IO.
2. 不要让Redis节点占满所有内存，因为RDB需要用到内存
3. 提高`repl_backlog` 大小，发现故障尽快恢复
4. 限制主节点master上的从节点数量，使用主-从-从链式模式

## 主从断连

如果主从库在命令传播时出现了网络闪断，那么从库就会和主库重新进行一次全量或增量复制

`replication buffer` 和 `repl_backlog_buffer`

- 一个从库如果和主库断连时间过长，造成它在主库`repl_backlog_buffer`的`slave_repl_offset`位置上的数据已经被覆盖掉了，此时从库和主库间将进行全量复制。
- 每个从库会记录自己的`slave_repl_offset`，每个从库的复制进度也不一定相同。在和主库重连进行恢复时，从库会通过`psync`命令把自己记录的`slave_repl_offset`发给主库，主库会根据从库各自的复制进度，来决定这个从库可以进行增量复制，还是全量复制。
